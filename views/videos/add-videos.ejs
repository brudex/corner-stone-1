<%- include('../partials/navbar.ejs') %> <%-
include('../partials/response-message.ejs') %>

<div class="pt-32pt">
  <div
    class="
      container
      page__container
      d-flex
      flex-column flex-md-row
      align-items-center
      text-center text-sm-left
    "
  >
    <div class="flex d-flex flex-column flex-sm-row align-items-center">
      <div class="mb-24pt mb-sm-0 mr-sm-24pt">
        <h2 class="mb-0">Add video</h2>

        <ol class="breadcrumb p-0 m-0">
          <li class="breadcrumb-item"><a href="/videos">Videos</a></li>
          <li class="breadcrumb-item">Add video</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- BEFORE Page Content -->

<!-- // END BEFORE Page Content -->

<!-- Page Content -->

<div class="container page__container page-section">
  <div class="row mb-32pt">
    <div class="col-lg-4">
      <div class="page-separator">
        <div class="page-separator__text">Add video</div>
      </div>
      <p class="card-subtitle text-70 mb-16pt mb-lg-0">
        Enter video title and select the video file to upload a video
      </p>
    </div>
    <div class="col-lg-8 d-flex align-items-center">
      <div class="flex" style="max-width: 100%">
        <form id="video-form">
          <div class="form-group">
            <label class="form-label" for="title">title*:</label>
            <input
              type="text"
              class="form-control"
              id="title"
              name="title"
              value="<% if(typeof values !== 'undefined') {%><%=values.title%><%}%>"
              placeholder="Enter video title"
              required
            />
          </div>

          <div class="form-group m-0">
            <label class="form-label" for="exampleInputPassword1"
              >Video file*</label
            >
            <div class="custom-file">
              <input
                type="file"
                id="file"
                class="custom-file-input"
                name="video-file"
                required
              />
              <label for="file" class="custom-file-label"
                >Select video file</label
              >
            </div>
          </div>
          <div
            class="form-group mt-2"
            id="progressContainer"
            style="visibility: hidden"
          >
            <label class="form-label" for="exampleInputPassword1"
              >Uploading file*</label
            >
            <div class="progress mb-16pt">
              <div
                id="progress"
                class="progress-bar progress-bar-striped bg-secondary"
                role="progressbar"
                style="width: 0%"
                aria-valuenow="50"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
            </div>
          </div>
          <div id="msg"></div>
          <button type="submit" class="btn btn-primary mt-3">Submit</button>
        </form>
      </div>
    </div>
  </div>
</div>
<%- include('../partials/drawer.ejs') %>

<script>
  const form = document.getElementById("video-form");

  const alertMsg = `<div class="alert alert-info" id="alert" role="alert">
              <div class="d-flex flex-wrap align-items-start">
                <div class="mr-8pt">
                  <i class="material-icons">info</i>
                </div>
                <div class="flex" style="min-width: 180px">
                  <small id="alert-msg" class="text-black-100"> </small>
                </div>
              </div>
            </div>`;

  form.addEventListener("submit", uploadForm);

  function uploadForm(e) {
    e.preventDefault();
    const formData = new FormData(form);

    const xhr = new XMLHttpRequest();

    xhr.open("POST", "/api/videos/add", true);
    xhr.upload.addEventListener("progress", (e) => {
      $("#progressContainer").css("visibility", "visible");
      $("#progress").css("width", `0%`);
      const percent = e.lengthComputable ? (e.loaded / e.total) * 50 : 0;
      $("#progress").css("width", `${percent}%`);
    });
    xhr.onerror = function (e) {
      $("#progressContainer").css("visibility", "hidden");
      $("#progress").css("width", `0%`);
      $("#msg").html(alertMsg);
      $("#alert-msg").text("An error Occurred");
    };
    xhr.onload = function () {
      const response = JSON.parse(this.responseText);
      $("#progressContainer").css("visibility", "hidden");
      $("#progress").css("width", `0%`);
      $("#msg").html(alertMsg);
      $("#alert-msg").text(response.message);
      form[0].reset();
    };

    xhr.send(formData);
  }
</script>
